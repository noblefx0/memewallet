<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trade Coin</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <header>
        <a href="index.html" style="color: #00ff9d; text-decoration: none; font-size: 18px">‚Üê Back</a>
        <h1>Trade</h1>
    </header>

    <main style="padding: 20px">
        <h2 id="coinName">Loading coin...</h2>
        <p id="currentPrice">Price: Loading...</p>
        <p id="change24h">24h Change: Loading...</p>

        <div style="margin: 30px 0">
            <label style="display: block; margin-bottom: 8px">Amount (USD):</label>
            <input type="number" id="amount" placeholder="e.g. 100" style="
                        width: 100%;
                        padding: 12px;
                        font-size: 16px;
                        border-radius: 8px;
                        border: 1px solid #444;
                        background: #1e1e1e;
                        color: white;
                    " />
        </div>

        <div style="display: flex; gap: 12px">
            <button id="buyBtn" style="
                        flex: 1;
                        padding: 14px;
                        background: #00ff9d;
                        color: black;
                        border: none;
                        border-radius: 10px;
                        font-weight: bold;
                        font-size: 16px;
                    ">
                Buy
            </button>
            <button id="sellBtn" style="
                        flex: 1;
                        padding: 14px;
                        background: #ff3b30;
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-weight: bold;
                        font-size: 16px;
                    ">
                Sell
            </button>
        </div>

        <p id="feedback" style="margin-top: 20px; font-size: 18px; text-align: center"></p>
    </main>
    <script src="wallet.js"></script>
    <script src="wallet.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const coinId = urlParams.get("coin");

        if (!coinId) {
            document.getElementById("coinName").innerHTML = "No coin selected";
        } else {
            async function loadCoin() {
                try {
                    const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${coinId}`);
                    const data = await response.json();

                    if (!data.pairs || data.pairs.length === 0) {
                        throw new Error("No pair found");
                    }

                    const pair = data.pairs[0];
                    const price = Number(pair.priceUsd);
                    const change = pair.priceChange?.h24 || 0;

                    document.getElementById("coinName").innerHTML = `${pair.baseToken.symbol} Trade`;
                    document.getElementById("currentPrice").innerHTML = `Price: $${price.toFixed(8)}`;

                    const changeText = change >= 0 ? `+${change}%` : `${change}%`;
                    const color = change >= 0 ? '#00ff9d' : '#ff3b30';
                    document.getElementById("change24h").innerHTML = `24h Change: <span style="color:${color};">${changeText}</span>`;
                } catch (error) {
                    console.error("Load error:", error);
                    document.getElementById("coinName").innerHTML = "Error loading coin";
                }
            }

            loadCoin();
        }

        // Buy button
        document.getElementById("buyBtn").onclick = () => {
            const amount = Number(document.getElementById("amount").value);
            if (amount <= 0 || isNaN(amount)) {
                document.getElementById("feedback").innerHTML = "Enter a valid amount!";
                return;
            }

            const priceText = document.getElementById("currentPrice").innerHTML;
            const currentPrice = Number(priceText.replace("Price: $", ""));

            const result = buyCoin(coinId, amount, currentPrice);
            document.getElementById("feedback").innerHTML = result.message;
        };

        // Sell placeholder
        document.getElementById("sellBtn").onclick = () => {
            const amountEl = document.getElementById("amount");
            const rawValue = amountEl.value.trim();
            const coinAmount = Number(rawValue);

            if (isNaN(coinAmount) || coinAmount <= 0) {
                document.getElementById("feedback").innerHTML = "Enter a valid amount!";
                document.getElementById("feedback").style.color = "red";
                return;
            }

            const priceText = document.getElementById("currentPrice").innerHTML;
            const currentPrice = Number(priceText.replace("Price: $", ""));

            if (isNaN(currentPrice) || currentPrice <= 0) {
                document.getElementById("feedback").innerHTML = "Invalid price";
                return;
            }

            const result = sellCoin(coinId, coinAmount, currentPrice);
            document.getElementById("feedback").innerHTML = result.message;
            document.getElementById("feedback").style.color = result.success ? "#00ff9d" : "red";

            if (result.success) amountEl.value = "";
        };
    </script>

</body>

</html>
